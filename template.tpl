___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Zeotap Collect Tag Template",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Will be used to track page views, custom events, collect user information, and consents",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "options",
    "displayName": "Initialisation Options",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "writeKey",
        "displayName": "Write Key",
        "simpleValueType": true,
        "help": "You will find this under the Source details in your Collect account",
        "valueHint": "eg. xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "user_country",
        "displayName": "User Country",
        "simpleValueType": true,
        "valueHint": "eg. DEU",
        "help": "ISO Alpha 3 country code. Will be used to determine storage region. Fallback - IP-based."
      },
      {
        "type": "TEXT",
        "name": "eventKey",
        "displayName": "Event Key",
        "simpleValueType": true,
        "valueHint": "eg. zeotapEvent",
        "help": "Key for event name in dataLayer object. leave the default if you use the GTM\u0027s default key.",
        "defaultValue": "event"
      },
      {
        "type": "SELECT",
        "name": "consent_method",
        "displayName": "Consent Method",
        "selectItems": [
          {
            "value": "default",
            "displayValue": "Default Opt-in"
          },
          {
            "value": "tcf",
            "displayValue": "Check TCF CMP"
          }
        ],
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "tcf"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "events",
    "displayName": "Track page views and events",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "pageViewName",
        "displayName": "Page View Tracking Event Name",
        "simpleValueType": true,
        "help": "Default event name when page view is triggered is \u0027gtm.js\u0027. You can override by adding another value here. We will make \u0027pageView\u0027 event calls for only that event.",
        "defaultValue": "gtm.js",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "eventTracking",
        "displayName": "Event Tracking",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "name_pattern",
            "displayName": "Event name",
            "simpleValueType": true,
            "help": "Enter a regex pattern that matches all event names you want to track. If you want to track just a single event just enter that event name.",
            "defaultValue": ".*",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "SIMPLE_TABLE",
            "name": "eventsList",
            "displayName": "Special Events",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Event Name",
                "name": "name",
                "type": "TEXT",
                "isUnique": true,
                "valueHint": "eg. add_to_cart"
              }
            ],
            "help": "Event names that we want to track apart from the regex provided."
          },
          {
            "type": "PARAM_TABLE",
            "name": "eventProperties",
            "displayName": "Pre Defined Properties",
            "paramTableColumns": [
              {
                "param": {
                  "type": "TEXT",
                  "name": "property_name",
                  "displayName": "Property Name",
                  "simpleValueType": true,
                  "valueHint": "eg. event_Name, page_category"
                },
                "isUnique": true
              },
              {
                "param": {
                  "type": "TEXT",
                  "name": "property_value",
                  "displayName": "Property Value",
                  "simpleValueType": true
                },
                "isUnique": false
              }
            ],
            "help": "Input the properties you\u0027d like to attach or override. You can define the values from your variables or provide static values for them."
          }
        ],
        "help": "For tracking events other than page view and consent."
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "excludePII",
        "displayName": "PII to be excluded",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "PII property name",
            "name": "name",
            "type": "TEXT",
            "valueHint": "eg. user.email",
            "selectItems": [
              {
                "value": "",
                "displayValue": "email"
              }
            ],
            "isUnique": true
          }
        ],
        "help": "Enter all the PII and user related fields in the dataLayer that needs to be excluded in event properties."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "identities",
    "displayName": "Login and identities setting",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "GROUP",
        "name": "user_login",
        "displayName": "User Login",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "login_event",
            "displayName": "Login Event",
            "simpleValueType": true,
            "help": "Specify the dataLayer event fired on user login",
            "defaultValue": "login"
          },
          {
            "type": "CHECKBOX",
            "name": "email_exists",
            "checkboxText": "Capture email",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "login_event",
                "paramValue": "",
                "type": "PRESENT"
              }
            ]
          },
          {
            "type": "SELECT",
            "name": "email",
            "displayName": "Email variable",
            "macrosInSelect": true,
            "selectItems": [],
            "simpleValueType": true,
            "notSetText": "",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "enablingConditions": [
              {
                "paramName": "email_exists",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "CHECKBOX",
            "name": "cellno_exists",
            "checkboxText": "Capture cellphone number",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "login_event",
                "paramValue": "",
                "type": "PRESENT"
              }
            ]
          },
          {
            "type": "SELECT",
            "name": "cellno",
            "displayName": "Cell number variable",
            "macrosInSelect": true,
            "selectItems": [],
            "simpleValueType": true,
            "notSetText": "",
            "enablingConditions": [
              {
                "paramName": "cellno_exists",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "CHECKBOX",
            "name": "loginid_exists",
            "checkboxText": "Capture Loginid",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "login_event",
                "paramValue": "",
                "type": "PRESENT"
              }
            ]
          },
          {
            "type": "SELECT",
            "name": "loginid",
            "displayName": "Login variable",
            "macrosInSelect": true,
            "selectItems": [],
            "simpleValueType": true,
            "notSetText": "",
            "enablingConditions": [
              {
                "paramName": "loginid_exists",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "CHECKBOX",
            "name": "areIdentitiesHashed",
            "checkboxText": "Are your identities hashed ?",
            "simpleValueType": true,
            "defaultValue": false,
            "enablingConditions": [
              {
                "paramName": "loginid_exists",
                "paramValue": "",
                "type": "PRESENT"
              }
            ]
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "allowIDP",
        "checkboxText": "Create First Party ID+ cookie on user login",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "login_event",
            "paramValue": "",
            "type": "PRESENT"
          }
        ],
        "defaultValue": true
      },
      {
        "type": "TEXT",
        "name": "partnerId",
        "displayName": "Organisation partner ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "allowIDP",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "help": "This id is provided by Zeotap on enabling ID+ for your organisation."
      },
      {
        "type": "TEXT",
        "name": "user_logout",
        "displayName": "User Logout",
        "simpleValueType": true,
        "help": "Specify dataLayer event capturing user logout",
        "enablingConditions": [
          {
            "paramName": "login_event",
            "paramValue": "",
            "type": "PRESENT"
          }
        ]
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "user_attributes",
        "displayName": "User Attributes",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Property Name",
            "name": "name",
            "type": "TEXT",
            "selectItems": [],
            "valueHint": "eg user.gender",
            "isUnique": true
          }
        ],
        "help": "Specify the dataLayer variables that contain user related information. The same will be passed in a setUserProperties call."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "google_analytics",
    "displayName": "Google Analytics Configurations",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "allowGAClientId",
        "checkboxText": "Pick Google Analytics client ID",
        "simpleValueType": true,
        "defaultValue": true
      },
      {
        "type": "TEXT",
        "name": "gaClientIdCookiePrefix",
        "displayName": "GA Client ID Cookie Prefix",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "allowGAClientId",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "gaUserIdCookieName",
        "displayName": "Pick GA User ID",
        "simpleValueType": true
      },
      {
        "type": "CHECKBOX",
        "name": "gaUserIdOnlyLoginEvent",
        "checkboxText": "Use only for Login Event",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "gaUserIdCookieName",
            "paramValue": "",
            "type": "PRESENT"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Enter your template code here.
const log = require('logToConsole');
const injectScript = require('injectScript');
const copyFromWindow = require('copyFromWindow');
const setInWindow = require('setInWindow');
const callInWindow = require('callInWindow');
const url = 'https://content.zeotap.com/sdk/zeotap.min.js';
const makeTableMap = require('makeTableMap');
const getType = require("getType");

function searchWith(array,searchFn){
  var k=0;
  array.forEach((value)=>{
    if(searchFn(value)){k=1;}
  });
  return k==1;
}
function isNamePresentIn(array,searchKey){
  return searchWith(array,(value)=>searchKey == value.name);
}

function removePIIs(listOfPIIs,eventData){
  log('removing Piis : ', listOfPIIs, eventData);
  var copy = {};
  var piiKey;
  for(let i=0;i<listOfPIIs.length;i++){
    piiKey = listOfPIIs[i].name; 
    if(!! eventData[piiKey]){
      eventData[piiKey] = undefined;
    }
  }
  for(let key in eventData){
    if(!!eventData[key]){
      copy[key] = eventData[key];
    }
  }
  log('returning after removing Piis : ', copy);
  return copy;
}

function mergePreviousData(dataLayer) {
    var mergedData = dataLayer[dataLayer.length-1];   
    // Very simple 'merge' that will not overwrite latest
    for (let d = dataLayer.length-2; d >= 0; d--) {
      let current = dataLayer[d];
      if (current.event === undefined) {
        for (let i in current){
          if (mergedData[i] === undefined) {
            mergedData[i] = current[i];
          }
        }
      } else {
        break; 
      }
    }
    return mergedData;
  }
function isNullOrEmpty(o){
    return o===null || o===undefined;
} 
function isEmptyString(s){
    return isNullOrEmpty(s) || (typeof s === 'string' && s.length<=0);
}
function getUserpropertiesFromData(eventData,propertiesList){
  var result = {};
  for(let p = propertiesList.length-1;p>=0;p--){
    let prop = propertiesList[p];
    result[prop.name] = eventData[prop.name];
  }
  return result;
}
function getEventData(_data,_dataLayer){
    // later this will be more sophisticated based on input config and tagType 
    var dataLayerMerged = mergePreviousData(_dataLayer);
    return dataLayerMerged;
  }
function matchStringWithRegex(str,regex){
  return regex.length>0 && str.search(regex)>-1;
}
const zeotapCallMethod = copyFromWindow('zeotap.callMethod');
// currently we assume the current state of the datalayer is the eventData for all pageView,normalEvents,userProperties being set
var dataLayer = copyFromWindow('dataLayer');

if(zeotapCallMethod == undefined) {
const consentOptions = {
    'default':[{key:'useConsent',value:false}],
    'tcf':[{key:'useConsent',value:true}, {key: 'checkForCMP', value:true}],
    'custom':[{key:'useConsent',value:true},{key:'checkForCMP',value:false}]
};
var consentMethod = data.consent_method;
log(consentMethod, consentOptions[consentMethod]);
var options = {
  user_country: data.user_country,
  allowIDP: data.allowIDP,
  partnerId: data.partnerId,
  useConsent: data.consent_method === 'default' ? false : true,
  checkForCMP: data.consent_method === 'tcf' ? true : false,
  allowGAClientId: data.allowGAClientId,
  gaClientIdCookiePrefix: data.gaClientIdCookiePrefix,
  gaUserIdCookieName: data.gaUserIdCookieName,
  gaUserIdOnlyLoginEvent: data.gaUserIdOnlyLoginEvent
};
  
  setInWindow("zeotap", { _q:[],_qcmp:[]});
  setInWindow('zeotap.callMethod', function() {
      callInWindow('zeotap._q.push', arguments);
  });
  log('zeotap.callMethod', 'init', data.writeKey,options);
  callInWindow('zeotap.callMethod', 'init', data.writeKey,options);
  log('pushed init to zeotap queue');
  log('state of dataLayer pre SDK init ... : ', dataLayer);
}


if(!!dataLayer){
  log('dataLayer exists on window : ', dataLayer);
  var eventData = getEventData(data,dataLayer);
  var eventNameKey = data.eventKey ||  'event';
  // parse the dataLayer and log the event that took place
  log('Tag fired for Event:',eventData[eventNameKey]);
  // now check the regex to see if it matches with the regex
  var regex = data.name_pattern;
  var eventList = data.eventsList || [];
  var pageViewEventName=data.pageViewName || 'gtm.js';
  var eventPropertiesList = data.eventProperties || [];
  var extraProperties = makeTableMap(eventPropertiesList,'property_name','property_value');
  var listOfPIIS = data.excludePII || [];
  var data_wo_pii = removePIIs(listOfPIIS,eventData);
  if( getType(eventData[eventNameKey]) == 'string' ){
    
    if(eventData[eventNameKey] == pageViewEventName){
      log('pageview event matched with eventname');
      //assuming setPageProperties( ...args) 
      callInWindow('zeotap.callMethod', 'setPageProperties',data_wo_pii);
    }
    else if(eventData[eventNameKey] == data.login_event){
      log('user logged in');
      var propertiesList = data.user_attributes || [];
      var userProperties = getUserpropertiesFromData(eventData,propertiesList);
      // call the setUserProperties
      callInWindow('zeotap.callMethod', 'setUserProperties',userProperties);
      // collect the pii values
      var identities = {};
      if(data.email_exists){
        identities.email = data.email;
      }
      if(data.loginid_exists){
        identities.loginid = data.loginid;
      }
      if(data.cellno_exists){
        identities.cellno_cc = data.cellno;
      }
      callInWindow('zeotap.callMethod', 'setUserIdentities',identities,data.areIdentitiesHashed);

    }
      
    else if(eventData[eventNameKey] == data.user_logout){
      callInWindow('zeotap.callMethod', 'unsetUserIdentities');
      var propertiesList = data.user_attributes;
      var userProperties = getUserpropertiesFromData(eventData,propertiesList);
      callInWindow('zeotap.callMethod', 'setEventProperties',data.user_logout,{});
    }
    
    else if( matchStringWithRegex(eventData[eventNameKey],regex) || isNamePresentIn(eventList,eventData[eventNameKey])){
      log('regex matched with event name');
      log('zeotap.callMethod', 'setEventProperties',eventData[eventNameKey],data_wo_pii,extraProperties);
      //assuming setPageProperties( ...args) 
      callInWindow('zeotap.callMethod', 'setEventProperties',eventData[eventNameKey],data_wo_pii,extraProperties);

    }
    
  }
}
  


injectScript(url, data.gtmOnSuccess, data.gtmOnFailure, 'zeoCollect');


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://content.zeotap.com/sdk/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "zeotap"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "zeotap.callMethod"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "zeotap._q"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "zeotap._q.push"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "zeotap.setUserProperties"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: should read options from data and make init call without consent
  code: |
    const mockData ={"cellno_exists":false,"consent_method":"default","login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"loginId","writeKey":"someKey","pageViewName":"pageView","eventKey":"event","name_pattern":"regex","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',undefined);

    // Call runCode to run the template's code.
    runCode(mockData);
    //mock('injectScript',(url,cbs,cbf,id)=>{cbs();});
    assertApi('setInWindow').wasCalledWith("zeotap", { _q:[],_qcmp:[]});
    assertApi('callInWindow').wasCalledWith('zeotap.callMethod','init',mockData.writeKey,{user_country:'IND',useConsent:false,allowIDP:mockData.allowIDP,partnerId:mockData.partnerId});
- name: should read option from data and make init call allowing cmp based consent
  code: |-
    const mockData ={"cellno_exists":false,"consent_method":"tcf","login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"loginId","writeKey":"someKey","pageViewName":"pageView","eventKey":"event","name_pattern":"regex","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',undefined);

    // Call runCode to run the template's code.
    runCode(mockData);
    //mock('injectScript',(url,cbs,cbf,id)=>{cbs();});
    assertApi('setInWindow').wasCalledWith("zeotap", { _q:[],_qcmp:[]});
    assertApi('callInWindow').wasCalledWith('zeotap.callMethod','init',mockData.writeKey,{user_country:'IND',useConsent:true,allowIDP:mockData.allowIDP,partnerId:mockData.partnerId});
- name: should read options from data and make init call for custom consent
  code: |-
    const mockData ={"cellno_exists":false,"consent_method":"custom","login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"loginId","writeKey":"someKey","pageViewName":"pageView","eventKey":"event","name_pattern":"regex","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',undefined);

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('setInWindow').wasCalledWith("zeotap", { _q:[],_qcmp:[]});
    assertApi('callInWindow').wasCalledWith('zeotap.callMethod','init',mockData.writeKey,{user_country:'IND',useConsent:true,checkForCMP:false,allowIDP:mockData.allowIDP,partnerId:mockData.partnerId});
- name: should read the last event name from dataLayer in the window from default
    event key
  code: |-
    const mockData ={"cellno_exists":false,"consent_method":"default","login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"loginId","writeKey":"someKey","pageViewName":"pageView","eventKey":"event","name_pattern":"regex","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',[{event:'test'}]);

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalledWith('dataLayer');
    assertApi('logToConsole').wasCalledWith("Tag fired for Event:","test");
- name: should be a setEventProperties call if the event name is part of the event
    list provided 1
  code: |-
    const mockData ={"cellno_exists":false,"consent_method":"default","login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"},{"name":"exitPage"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"loginId","writeKey":"someKey","pageViewName":"pageView","eventKey":"event","name_pattern":"","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',[{event:'addToCart',zeoEvent:'zeoTest'}]);

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalledWith('dataLayer');
    assertApi('logToConsole').wasCalledWith("regex matched with event name");
- name: should be a setPageProperties call if the event name matches with provided
    pageview name
  code: |-
    const mockData ={"cellno_exists":false,"consent_method":"default","login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"loginId","writeKey":"someKey","pageViewName":"pageView","eventKey":"event","name_pattern":"^zeo","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',[{event:'pageView',}]);

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalledWith('dataLayer');
    assertApi('logToConsole').wasNotCalledWith("regex matched with event name");
    assertApi('logToConsole').wasCalledWith("pageview event matched with eventname");
- name: should call setUserProperties and setUserIdentities log message if the event
    name is login_event
  code: |-
    const mockData ={"cellno_exists":false,"consent_method":"default","login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"},{"name":"exitPage"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"loginId","writeKey":"someKey","pageViewName":"pageView","eventKey":"event","name_pattern":"","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',[{event:'login',zeoEvent:'zeoTest'}]);

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalledWith('dataLayer');
    assertApi('logToConsole').wasCalledWith("user logged in");
- name: should call unsetUserIdentities if the event name is logout_event
  code: |
    const mockData ={"cellno_exists":false,"consent_method":"default","login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"},{"name":"exitPage"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"logout","writeKey":"someKey","pageViewName":"pageView","eventKey":"event","name_pattern":"","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',[{event:'logout',zeoEvent:'zeoTest'}]);

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalledWith('dataLayer');
    assertApi('logToConsole').wasCalledWith("user logged out");
    assertApi('logToConsole').wasNotCalledWith("regex matched with event name");
- name: should call the setConsent method with provided consent purpose and consent
    value if event is custom consent event
  code: |-
    const mockData ={"cellno_exists":false,"consent_method":"custom","consent_event_name":"setConsent","custom_consent_value_property":"consent","pass_consent_purposes":"all","true_property_value":'yes',"login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"},{"name":"exitPage"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"logout","writeKey":"someKey","pageViewName":"pageView","eventKey":"event","name_pattern":"","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',[{event:'setConsent',zeoEvent:'zeoTest','consent':'yes',}]);

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalledWith('dataLayer');
    assertApi('logToConsole').wasCalledWith("setConsent to true","all");
- name: should call the setConsent method with provided consent purpose and consent
    value(false) if event is custom consent event
  code: |-
    const mockData ={"cellno_exists":false,"consent_method":"custom","consent_event_name":"setConsent","custom_consent_value_property":"consent","pass_consent_purposes":"all","true_property_value":'yes',"login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"},{"name":"exitPage"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"logout","writeKey":"someKey","pageViewName":"pageView","eventKey":"event","name_pattern":"","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',[{event:'setConsent',zeoEvent:'zeoTest','consent':'no',}]);

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalledWith('dataLayer');
    assertApi('logToConsole').wasCalledWith("setConsent to false","all");
- name: should do nothing if the event name matches no event criteria
  code: |-
    const mockData ={"cellno_exists":false,"consent_method":"default","login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"},{"name":"exitPage"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"logout","writeKey":"someKey","pageViewName":"pageView","eventKey":"event","name_pattern":"","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',[{event:'random',zeoEvent:'zeoTest'}]);

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalledWith('dataLayer');
    assertApi('logToConsole').wasNotCalledWith("user logged in");
    assertApi('logToConsole').wasNotCalledWith("user logged out");
    assertApi('logToConsole').wasNotCalledWith("regex matched with event name");
    assertApi('logToConsole').wasNotCalledWith("pageview event matched with eventname");
- name: should not log a message if the event name does not matches with provided
    regex
  code: |-
    const mockData ={"cellno_exists":false,"consent_method":"default","login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"loginId","writeKey":"someKey","pageViewName":"pageView","eventKey":"zeoEvent","name_pattern":"^zeo","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',[{event:'test',zeoEvent:'Testzeo'}]);

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalledWith('dataLayer');
    assertApi('logToConsole').wasNotCalledWith("regex matched with event name");
    assertApi('logToConsole').wasNotCalledWith("pageview event matched with eventname");
- name: should not log a message if the event name does not matches with provided
    pageview name
  code: |-
    const mockData ={"cellno_exists":false,"consent_method":"default","login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"loginId","writeKey":"someKey","pageViewName":"pageView","eventKey":"event","name_pattern":"^zeo","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',[{event:'pageViewNot',}]);

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalledWith('dataLayer');
    assertApi('logToConsole').wasNotCalledWith("regex matched with event name");
    assertApi('logToConsole').wasNotCalledWith("pageview event matched with eventname");
- name: should log message if the event name is part of the event list provided 2
  code: |-
    const mockData ={"cellno_exists":false,"consent_method":"default","login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"},{"name":"exitPage"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"loginId","writeKey":"someKey","pageViewName":"pageView","eventKey":"event","name_pattern":"","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',[{event:'exitPage',zeoEvent:'zeoTest'}]);

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalledWith('dataLayer');
    assertApi('logToConsole').wasCalledWith("regex matched with event name");
- name: should not log message if the event name is not part of the event list provided
    2
  code: |-
    const mockData ={"cellno_exists":false,"consent_method":"default","login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"},{"name":"exitPage"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"loginId","writeKey":"someKey","pageViewName":"pageView","eventKey":"event","name_pattern":"","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',[{event:'1exitPage1',zeoEvent:'zeoTest'}]);

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalledWith('dataLayer');
    assertApi('logToConsole').wasNotCalledWith("regex matched with event name");
- name: should read the last event name from dataLayer in the window from custom event
    key
  code: |-
    const mockData ={"cellno_exists":false,"consent_method":"default","login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"loginId","writeKey":"someKey","pageViewName":"pageView","eventKey":"zeoEvent","name_pattern":"regex","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',[{event:'test',zeoEvent:'zeoTest'}]);

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalledWith('dataLayer');
    assertApi('logToConsole').wasCalledWith("Tag fired for Event:","zeoTest");
- name: should be a setEventProperties call if the event name matches with provided
    regex
  code: |+
    const mockData ={"cellno_exists":false,"consent_method":"default","login_event":"login","user_country":"IND","eventsList":[{"name":"addToCart"}],"loginid_exists":false,"user_attributes":[{"name":"age"}],"excludePII":[{"name":"email"}],"email_exists":true,"user_logout":"loginId","writeKey":"someKey","pageViewName":"pageView","eventKey":"zeoEvent","name_pattern":"^zeo","partnerId":"testId","allowIDP":true,"properties":[{"property_name":"newProp","property_value":"newValue"}],"gtmTagId":2147483646,"gtmEventId":1};
    mock('copyFromWindow',[{event:'test',zeoEvent:'zeoTest',email:'abc@xyz.com',cellno:'10'}]);

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalledWith('dataLayer');
    assertApi('logToConsole').wasCalledWith("regex matched with event name");

setup: ''


___NOTES___

Created on 01/12/2020, 10:44:11


